<htmlform>
	<br/>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>
	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Spiromentry Test Results (v1.0)</h2>
	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Test Results Date:</td>
				<td>
					<encounterDate default="today"/>
				</td>
			</tr>
			<tr>
				<td>Location:</td>
				<td>
					<encounterLocation default="1"/>
				</td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td>
					<encounterProvider default="currentUser" type="autocomplete"/>
				</td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Spiromentry Test - 1st Reading">
  <span id="test"></span>
			<p>
				<lookup expression="fn.getConcept('149').description"/>
				<obs conceptId="149" id="barcode" size="13"/>
			</p>
	 <table>
	<tr>
	   <td> </td>
	   <td align="center"> Actual <br/> Result </td>
	   <td align="center"> Predicted <br/> Result </td>
	   <td align="center"> Percentage </td>
	</tr>
	<tr>
	   <td> FVC </td>
	   <td align="center"><obs conceptId="150" id="fvc_result"/></td>
	   <td align="center"><obs conceptId="475" id="fvc_predicted_result"/></td>
	   <td align="center"><obs conceptId="476" id="fvc_percentage"/></td>
	</tr>
	<tr>
	   <td> FEV1 </td>
	   <td align="center"> <obs conceptId="151" id="fev1_result"/> </td>
	   <td align="center"> <obs conceptId="154" id="fev1_predicted_result"/> </td>
	   <td align="center"> <obs conceptId="477" id="fev1_percentage"/> </td>
	</tr>
	<tr>
	    <td> FVC/FEV1 Ratio</td>
	    <td align="center"> <obs conceptId="152" id="fvc_fev1_ratio"/> </td>
	    <td align="center"> <obs conceptId="478" id="fvc_fev1_ratio_predicted"/> </td>
	    <td align="center"> <obs conceptId="479" id="fvc_fev1_percentage"/> </td>
	</tr>
	<tr>
	    <td> PEF Result </td>
	    <td align="center"> <obs conceptId="480" id="pef_result"/> </td>
	    <td align="center"> <obs conceptId="481" id="pef_predicted"/> </td>
	    <td align="center"> <obs conceptId="482" id="pef_percentage"/> </td>
	</tr>
	</table>
                  <div id="copd_test_div">	
			<p>
				<lookup expression="fn.getConcept('153').description"/><br/>
				<obs conceptId="153" id="copd_patient" answerConceptIds="1,2" defaultValue="2" style="radio"/>
			</p>
		</div>	
                     <div id="copd_stage_div">
			<p>
				<lookup expression="fn.getConcept('155').description"/><br/>
				<obs conceptId="155" id="copd_stage" answerConceptIds="54,55,52,53" style="radio" />
			</p>
                   </div>
              

            <div id="asthama_div">
            <p>
                 <lookup expression="fn.getConcept('483').description"/><br/>
                 <obs conceptId="483" id="post_inhaling_reading" answerConceptIds="1,2" defaultValue="2" style="radio"/>
            </p>
            </div>         

	</section>

        
        <section headerLabel="3. 2nd Reading (Post-Brochodilation)">
	<div id="post_inhaling_div">
	        <br/>
                        <table>
			<tr>
			   <td> </td>
			   <td align="center"> Actual <br/> Result </td>
			   <td align="center"> Predicted <br/> Result </td>
			   <td align="center"> Percentage </td>
			</tr>
			<tr>
			   <td> FVC </td>
			   <td align="center"><obs conceptId="484" id="fvc_result_2"/></td>
			   <td align="center"><obs conceptId="485" id="fvc_predicted_result_2"/></td>
			   <td align="center"><obs conceptId="486" id="fvc_percentage_2"/></td>
			</tr>
			<tr>
			   <td> FEV1 </td>
			   <td align="center"> <obs conceptId="487" id="fev1_result_2"/> </td>
			   <td align="center"> <obs conceptId="488" id="fev1_predicted_result_2"/> </td>
			   <td align="center"> <obs conceptId="489" id="fev1_percentage_2"/> </td>
			</tr>
			<tr>
			    <td> FVC/FEV1 Ratio</td>
			    <td align="center"> <obs conceptId="490" id="fvc_fev1_ratio_2"/> </td>
			    <td align="center"> <obs conceptId="491" id="fvc_fev1_ratio_predicted_2"/> </td>
			    <td align="center"> <obs conceptId="492" id="fvc_fev1_percentage_2"/> </td>
			</tr>
			<tr>
			    <td> PEF Result </td>
			    <td align="center"> <obs conceptId="493" id="pef_result_2"/> </td>
			    <td align="center"> <obs conceptId="494" id="pef_predicted_2"/> </td>
			    <td align="center"> <obs conceptId="495" id="pef_percentage_2"/> </td>
			</tr>
			</table>
                     <p>
			   <lookup expression="fn.getConcept('500').description"/><br/>
                           <obs conceptId="483" id="asthma_diagnosis_classification" answerConceptIds="497,498,499" style="radio"/>
		    </p>
	</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		if(jQuery) {
			$j(document).ready(function() {                             

                             var asthamaDiv = $j("#asthama_div");
		             asthamaDiv.hide();
                             var copdTestDiv = $j("#copd_test_div");
                             copdTestDiv.hide();
                             var copdStageDiv = $j("#copd_stage_div");
                             copdStageDiv.hide();

                                    $j("#barcode").change(function() {
                                    getField('barcode.error').html('').hide();
                                    barcodeValue = getValue('barcode.value');
				    var spirometryBarcodes = " <lookup  complexExpression="#foreach($id in $fn.allObs(149)) #if($id.encounter.encounterType.id == 14) $id.valueText  #end  #end"/>";
                                    spirometryBarcodes = spirometryBarcodes.replace( /\s+/g, ' ' );
                                    spirometryBarcodes = spirometryBarcodes.trim();
				    var resultArray = spirometryBarcodes.split(" ");
                                    var testType = "<lookup  complexExpression="#foreach($id in $fn.allObs(474)) $id.valueCoded #end"/>";
                                    testType = testType.replace( /\s+/g, ' ' );
                                    testType = testType.trim();
                                    var testArray = testType.split(" ");
                                    var resultArrayLength = resultArray.length;
                                    var testArrayLength = testArray.length;
                                    if(resultArrayLength == testArrayLength){
                                    var flag = false;
                                         
                                        for (var i = resultArrayLength-1; 0 &lt;= i; i--) 
		                        {
                                            
                                              if(barcodeValue == resultArray[i]) {  
                                                 flag = true;  
                                                 showTest(testArray[i]);  
                                                 break;
                                                }
                                           
                                        }

                                      if(!flag){
                                           getField('barcode.error').html('Lab test code is invalid or does not exist. Please check that you have entered correct lab test code').show();
                                      }                                  

                                   }else getField('barcode.error').html('Error, while searching for Lab Test Code in OpenMRS.').show();
			}); 

                             $j("#fvc_percentage").find("input").attr("disabled", true);
			     $j("#fev1_percentage").find("input").attr("disabled", true);
			     $j("#fvc_fev1_percentage").find("input").attr("disabled", true);
                             $j("#pef_percentage").find("input").attr("disabled", true);
                             $j("#fvc_percentage_2").find("input").attr("disabled", true);
			     $j("#fev1_percentage_2").find("input").attr("disabled", true);
			     $j("#fvc_fev1_percentage_2").find("input").attr("disabled", true);
                             $j("#pef_percentage_2").find("input").attr("disabled", true);
                             $j("#copd_patient").find("input").attr("disabled", true);
                             $j("#copd_stage").find("input").attr("disabled", true);
                              $j("#asthma_diagnosis_classification").find("input").attr("disabled", true);
            
                             $j("#fvc_result").change(function() {
					autoPopulateResults();
				});
			     $j("#fvc_predicted_result").change(function() {
					autoPopulateResults();
			        });
			     $j("#fev1_result").change(function() {
					autoPopulateResults();
				});
			     $j("#fev1_predicted_result").change(function() {
					autoPopulateResults();
			        });
			     $j("#fvc_fev1_ratio").change(function() {
					autoPopulateResults();
				});
			     $j("#fvc_fev1_ratio_predicted").change(function() {
					autoPopulateResults();
			       });
			     $j("#pef_result").change(function() {
					autoPopulateResults();
				});
			     $j("#pef_predicted").change(function() {
					autoPopulateResults();
			       });
                             $j("#fvc_result_2").change(function() {
					autoPopulateResults();
				});
			      $j("#fvc_predicted_result_2").change(function() {
					autoPopulateResults();
			        });
			       $j("#fev1_result_2").change(function() {
					autoPopulateResults();
				});
			       $j("#fev1_predicted_result_2").change(function() {
					autoPopulateResults();
			         });
			        $j("#fvc_fev1_ratio_2").change(function() {
					autoPopulateResults();
				 });
			       $j("#fvc_fev1_ratio_predicted_2").change(function() {
					autoPopulateResults();
			         });
			       $j("#pef_result_2").change(function() {
					autoPopulateResults();
				 });
			       $j("#pef_predicted_2").change(function() {
					autoPopulateResults();
			         });
                               $j("#post_inhaling_reading").change(function() {
				var postInhalingDiv = $j("#post_inhaling_div");
				var postInhalingValue = getValue('post_inhaling_reading.value');
				if (postInhalingValue == 1) {
					postInhalingDiv.show();
				}
				else {
					postInhalingDiv.hide();
				    }
			      });
			      $j("#post_inhaling_reading").change();  

			});

		}
	
               
              function showTest(val){
		var asthamaDiv = $j("#asthama_div");
                 var copdTestDiv = $j("#copd_test_div");

                 if(val == 175){
		       asthamaDiv.show();
                       copdTestDiv.hide();
                     }
                  else{
                      copdTestDiv.show();
                      asthamaDiv.hide();
                    }

          }


                function autoPopulateResults() {
                         
                    var fvcValue = getValue("fvc_result.value");
		    var fvcPredicted = getValue("fvc_predicted_result.value");
		    if(!(fvcValue ==  "" || fvcPredicted == "")){
		        var ratio = Math.round(fvcValue / fvcPredicted * 100);
		        setValue("fvc_percentage.value", ratio);
		    } 
                    else setValue("fvc_percentage.value", "");

                    // w36 is the name of copd_stage radio group on HTML page
		    var copdStageRadios = $j("input[name=w36]");
                    var fev1Value = getValue("fev1_result.value");
		    var fev1Predicted = getValue("fev1_predicted_result.value");
		    if(!(fev1Value ==  "" || fev1Predicted == "")){
		       var ratio = Math.round(fev1Value / fev1Predicted * 100);
		       setValue("fev1_percentage.value", ratio);
                       // If ratio >= 80 then check "Mild"; if 50-79, then "Moderate"; if 30-49, then "Sever", otherwise "Very Severe"
				if (ratio >= 80) {
					copdStageRadios[0].checked = true;
				}
				else if (ratio >= 50) {
					copdStageRadios[1].checked = true;
				}
				else if (ratio >= 30) {
					copdStageRadios[2].checked = true;
				}
				else {
					copdStageRadios[3].checked = true;
                                        }
		    } 
                    else {
                            setValue("fev1_percentage.value", "");
                            copdStageRadios[0].checked = true;
                            }

                  var fvc_fev1Value = getValue("fvc_fev1_ratio.value");
		  var fvc_fev1Predicted = getValue("fvc_fev1_ratio_predicted.value");
		  // w34 is the name of copd_patient radio group on HTML page
	          var fvcFev1Radios = $j("input[name=w34]");
		  if(!(fvc_fev1Value ==  "" || fvc_fev1Predicted == "")){
		      var ratio = Math.round(fvc_fev1Value / fvc_fev1Predicted * 100);
		      setValue("fvc_fev1_percentage.value", ratio);
                      // If ratio is less than 80, then check "Yes", otherwise check "No" 
			   if (ratio &lt; 80) {
				fvcFev1Radios[0].checked = true;	
                                var copdStageDiv = $j("#copd_stage_div");
                                copdStageDiv.show(); 
                                }	      
                           else{
                               fvcFev1Radios[1].checked = true;
                               var copdStageDiv = $j("#copd_stage_div");
                               copdStageDiv.hide();
                               }
		    }
		    else {
		            setValue("fvc_fev1_percentage.value", "");
                            fvcFev1Radios[1].checked = true;
                            var copdStageDiv = $j("#copd_stage_div");
                            copdStageDiv.hide();
		           }  

                   var pefValue = getValue("pef_result.value");
		   var pefPredicted = getValue("pef_predicted.value");
		   if(!(pefValue ==  "" || pefPredicted == "")){
		       var ratio = Math.round(pefValue / pefPredicted * 100);
		       setValue("pef_percentage.value", ratio);
		    }
                  else setValue("pef_percentage.value", "");

                 var fvcValue2 = getValue("fvc_result_2.value");
		    var fvcPredicted2 = getValue("fvc_predicted_result_2.value");
		    if(!(fvcValue2 ==  "" || fvcPredicted2 == "")){
		       var ratio = Math.round(fvcValue2 / fvcPredicted2 * 100);
			   setValue("fvc_percentage_2.value", ratio);
		    }
		    else setValue("fvc_percentage_2.value", ""); 
		    
		     // w64 is the name of asthma_diagnosis_class radio group on HTML page
		    var asthmaDiagnosisRadios = $j("input[name=w64]");
		    var fev1Value2 = getValue("fev1_result_2.value");
		    var fev1Predicted2 = getValue("fev1_predicted_result_2.value");
		    if(!(fev1Value2 ==  "" || fev1Predicted2 == "")){
		       var ratio = Math.round(fev1Value2 / fev1Predicted2 * 100);
			   setValue("fev1_percentage_2.value", ratio);
			   // If ratio >= 80 then check "Mild"; if 50-79, then "Moderate"; if 30-49, then "Sever", otherwise "Very Severe"
				if (ratio > 80) {
					asthmaDiagnosisRadios[0].checked = true;
				}
				else if (ratio >= 60) {
					asthmaDiagnosisRadios[1].checked = true;
				}
				else {
					asthmaDiagnosisRadios[2].checked = true;
				}
		    }
		    else {
		          setValue("fev1_percentage_2.value", "");
		          asthmaDiagnosisRadios[0].checked = true;
		         }
		    
		    var fvc_fev1Value2 = getValue("fvc_fev1_ratio_2.value");
		    var fvc_fev1Predicted2 = getValue("fvc_fev1_ratio_predicted_2.value");
		    if(!(fvc_fev1Value2 ==  "" || fvc_fev1Predicted2 == "")){
		       var ratio = Math.round(fvc_fev1Value2 / fvc_fev1Predicted2 * 100);
			   setValue("fvc_fev1_percentage_2.value", ratio);  
		    }
		    else setValue("fvc_fev1_percentage_2.value", "");
		            
		    
		    var pefValue2 = getValue("pef_result_2.value");
		    var pefPredicted2 = getValue("pef_predicted_2.value");
		    if(!(pefValue2 ==  "" || pefPredicted2 == "")){
		       var ratio = Math.round(pefValue2 / pefPredicted2 * 100);
			   setValue("pef_percentage_2.value", ratio);
		    }
		    else setValue("pef_percentage_2.value", "");

              }
 
		function luhnCheckDigit(number) {
			var validChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVYWXZ_";
			number = number.toUpperCase().trim();
			var sum = 0;
			for (var i = 0; i &lt; number.length; i++) 
			{
				var ch = number.charAt(number.length - i - 1);
				if (validChars.indexOf(ch) &lt; 0) {
					return -1;
				}
				var digit = ch.charCodeAt(0) - 48;
				var weight;
				if (i % 2 == 0) {
					weight = (2 * digit) - parseInt(digit / 5) * 9;
				}
				else {
					weight = digit;
				}
				sum += weight;
			}
			sum = Math.abs(sum) + 10;
			var digit = (10 - (sum % 10)) % 10;
			return digit;
		}
		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			// Validate barcode
			var valid = true;
			var error = '';
			var barcode = getValue('barcode.value');
			var pattern = new RegExp("^\\d{1,10}-\\d$");
			valid = pattern.test(barcode);
			if (!valid || barcode.length > 12) {
				error = "Lab test code is invalid or empty. Please check that you have entered correct lab test code.\n";
			}
			else {
				// Check Luhn digit for barcode
				var number = barcode.substring(0, barcode.length - 2);
				var digit = barcode.charAt(barcode.length - 1);
				var luhnDigit = luhnCheckDigit(number);
				if (digit != luhnDigit) {
					valid = false;
			    	error = "Lab test code is invalid or does not exist. Please check that you have entered correct lab test code.\n";			
				}
			}
			if (!valid) {
				alert (error);
			}

            var testId = document.getElementById("test").innerHTML;
            var secondReading = getValue('post_inhaling_reading.value');

            if(testId == 176 || secondReading == 2) {
               
                var valueText = getValue('fvc_percentage.value');
                if(valueText == ''){
                    valid=false;
                    error = error + "FVC values can't be empty.\n";
                }
                valueText = getValue('fev1_percentage.value');
                if(valueText == ''){
                    valid= false;
                    error = error + "FEV1 values can't be empty.\n";
                }
                valueText = getValue('fvc_fev1_percentage.value');
                if(valueText == ''){
                    valid= false;
                    error = error + "FVC/FEV1 values can't be empty.\n";
                }
                valueText = getValue('pef_percentage.value');
                if(valueText == ''){
                    valid= false;
                    error = error + "PEF values can't be empty.\n";
                }
           }

           else{
               
                var valueText = getValue('fvc_percentage.value');
                var valueText2 = getValue('fvc_percentage_2.value');
                if(valueText == '' || valueText2 == ''){
                    valid=false;
                    error = error + "FVC values can't be empty.\n";
                }
                valueText = getValue('fev1_percentage.value');
                valueText2 = getValue('fev1_percentage_2.value');
                if(valueText == ''  || valueText2 == ''){
                    valid= false;
                    error = error + "FEV1 values can't be empty.\n";
                }
                valueText = getValue('fvc_fev1_percentage.value');
                valueText2 = getValue('fvc_fev1_percentage_2.value');
                if(valueText == ''  || valueText2 == ''){
                    valid= false;
                    error = error + "FVC/FEV1 values can't be empty.\n";
                }
                valueText = getValue('pef_percentage.value');
                valueText2 = getValue('pef_percentage_2.value');
                if(valueText == ''  || valueText2 == ''){
                    valid= false;
                    error = error + "PEF values can't be empty.\n";
                }

             }
                
                if (!valid) {
				alert (error);
			}


	        return valid;
		});
	</script>
</htmlform>