<htmlform>
	<br/>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>
	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

<span style="float: right">Paper Form ID: $paperFormId</span>
<h2>Diabetes Follow-up Treatment Form (v1.0)</h2>

<section headerLabel="1. Encounter Details">
<table class="baseline-aligned">
	<tr>
		<td>Date:</td>
		<td><encounterDate default="today" id="formDate" />
		</td>
	</tr>
	<tr>
		<td>Location:</td>
		<td><encounterLocation default="1" />
		</td>
	</tr>
	<tr>
		<td>Provider (Auto):</td>
		<td><encounterProvider default="currentUser" type="autocomplete" />
		</td>
	</tr>
</table>
</section> <section headerLabel="2. Treatment Follow up">
<div>
	<p>

		Date of Treatment Initiation: <b> <span id="date-value"> <lookup
		complexExpression="#if ($fn.latestObs(388)) #if ($fn.latestObs(388).valueCoded == 1) $fn.latestObs(388).getEncounter().getEncounterDatetime() #end #end" />
		</span> </b>
	</p>
	<p>
		<lookup expression="fn.getConcept('283').description" />
		:
		<obs conceptId="283" id="currentMonth" />
	</p>
	<p>
		Current Regimen:
		<lookup expression="fn.latestObs(356).valueCoded.name" />
	</p>
	<p>
		Blood Sugar Test Id: <select id="test-list" name="test-list">
		</select>

	</p>

	<p>
		<lookup expression="fn.getConcept('139').description" />
		:
		<obs conceptId="139" id="sugar_result" />
		<obs conceptId="518" id="sugar_test_type" />
	</p>
</div>
</section> <section headerLabel="3. Follow up History - Moderate Side Effects">
<div>
	<p>
		<lookup expression="fn.getConcept('329').description" />
		: <br />
		<obs conceptId="329" id="nausea" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('330').description" />
		:<br />
		<obs conceptId="330" id="diarrhea" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('332').description" />
		:<br />
		<obs conceptId="332" id="palpitation" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('335').description" />
		:<br />
		<obs conceptId="335" id="hypoglycemia" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('341').description" />
		:<br />
		<obs conceptId="341" id="fainting_spells" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('507').description" />
		:<br />
		<obs conceptId="507" id="other_symptoms" defaultValue="2" />
	</p>
	<div id="other_div">
		<p>
			Specify:<br />
			<obs conceptId="334" id="other_symptom" />
		</p>
	</div>
</div>
</section> <section headerLabel="3. Follow up History - Severe Side Effects">
<div>
	<div id="female_div">
		<p>
			Change in pregancy status<br />
			<obs conceptId="286" id="pregnant" answerConceptIds="1,2"
				defaultValue="2" />
		</p>
		<p>
			Change in breastfeeding status<br />
			<obs conceptId="287" id="breastfeeding" answerConceptIds="1,2"
				defaultValue="2" />
		</p>
	</div>
	<p>
		<lookup expression="fn.getConcept('340').description" />
		:<br />
		<obs conceptId="340" id="jaundice" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('391').description" />
		:<br />
		<obs conceptId="391" id="severe_hypoglycemia" defaultValue="2" />
	</p>
</div>
</section> <section headerLabel="4. Follow up Home Monitoring">
<div>
	<p>
		<lookup expression="fn.getConcept('508').description" />
		:<br />
		<obs conceptId="508" id="visit_number" />
	</p>
	<p>
		<lookup expression="fn.getConcept('379').description" />
		:<br />
		<obs conceptId="379" id="glucose_Monitoring"
			answerConceptIds="377,378" defaultValue="377" />
	</p>
</div>
</section> <section headerLabel="4. New Regimen">
<div>
	<p>
		<lookup expression="fn.getConcept('509').description" />
		:<br />
		<obs conceptId="509" id="adverse_effect" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('452').description" />
		:<br />
		<obs conceptId="452" id="regimen_change" defaultValue="2" />
	</p>
	<div id="new_regimen_div">
		<p>
			<lookup expression="fn.getConcept('356').description" />
			:<br />
			<obs conceptId="356" id="new_regimen"
				answerConceptIds="510,511,512,513,514,515" />
		</p>
	</div>
	<p>
		<lookup expression="fn.getConcept('453').description" />
		:<br />
		<obs conceptId="453" id="patient_referral" defaultValue="2" />
	</p>
	<p>
		<lookup expression="fn.getConcept('472').description" />
		:<br />
		<obs conceptId="472" id="current_status"
			answerConceptIds="464,471,469" defaultValue="464" />
	</p>
	<p>
		<lookup expression="fn.getConcept('398').description" />
		:<br />
		<obs conceptId="398" id="next_drug_dispersal" allowFutureDates="true" />
	</p>
</div>
</section> <submit /> 


<script type="text/javascript">
        
	if(jQuery){
    	 $j(document).ready(function() {
    	
           var treatmentInitiated = "<lookup expression="fn.latestObs(388).valueCoded.name" />";
           if(treatmentInitiated == "No"){
                  alert("Diabetes treatment NOT initiated for the patient.");
            }
           else  if(treatmentInitiated == "Yes"){
                 
            }
           else {
                alert("Diabetes First Encounter form is not submitted for the patient. Please submit the form to continue.");
           }

           var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(138)) #if($id.encounter.encounterType.id == 19) $id.valueText+$id.encounter.encounterDatetime  #end  #end"/>";
           value = value.replace(/[+]/g,'('); 
           value = value.replace(/ 00:00:00.0/g,')');  
           value = value.replace(/(^\s+|\s+$)/g,'');
           var result = value.replace(/\s+/g, ';');
           var resultArray = result.split(";");   

           var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(139)) #if($id.encounter.encounterType.id == 19) $id.valueText  #end  #end"/>";
           value = value.replace(/(^\s+|\s+$)/g,'');
           var result = value.replace(/\s+/g, ';');
           var resultValueArray = result.split(";");

           var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(138)) #if($id.encounter.encounterType.id == 18) $id.valueText  #end  #end"/>";
           value = value.replace(/(^\s+|\s+$)/g,'');
           var result = value.replace(/\s+/g, ';');
           var resultIdArray = result.split(";");
                                  
           var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(135)) #if($id.encounter.encounterType.id == 18) $id.valueCoded  #end  #end"/>";
           value = value.replace(/(^\s+|\s+$)/g,'');
           var result = value.replace(/\s+/g, ';');
           var resultTestTypeArray = result.split(";");

           for(var j = resultIdArray.length-1; 0 &lt;= j; j--){
               for(var i = resultArray.length-1; 0 &lt;= i; i--){
                    var array = resultArray[i].split("(");
                    if(resultIdArray[j] == array[0]){
                       resultValueArray[i] = resultValueArray[i]+";"+resultTestTypeArray[j]; 
                       }                                      
                }
           }
             
           var select = document.getElementById("test-list");

           for(var i = resultArray.length-1; 0 &lt;= i; i--){

               var optn = document.createElement("OPTION");
               var array = resultArray[i].split("(");
               optn.text = array[0].concat(' (').concat(array[1]);
               optn.value = resultValueArray[i];
               select.add(optn, 0);   
            }

           // If gender is male, then hide Pregnancy and Breastfeeding questions
           var gender = "<lookup expression="patient.gender"/>";
           var femaleDiv = $j("#female_div");
           if (gender == "M") {
			 femaleDiv.hide();
	   		 }

           //Other symptoms div hide and show 
           $j("#other_symptoms").change(function() {
		   		var otherDiv = $j("#other_div");
		   		var otherSymptoms = getValue('other_symptoms.value');
		   		if (otherSymptoms == 1) {
					otherDiv.show();
		      	}
		   		else {
					otherDiv.hide();
		      	}
	       });$j("#other_symptoms").change();

	       // New regimen div hide and show 
           $j("#regimen_change").change(function() {
			    var newRegimenDiv = $j("#new_regimen_div");
			    var regimenChange = getValue('regimen_change.value');
			    if (regimenChange == 1) {
					newRegimenDiv .show();
			    }
		   		else {
					newRegimenDiv .hide();
		      	}
	       });$j("#regimen_change").change();

            // formDate Change
			$j("#formDate").change(function() {
				var formDate = getValue('formDate.value');
				var valueDate = document.getElementById('date-value').innerText;
                                var months = diffMonth(valueDate,formDate);
                                var mon = parseInt(months);
                                setValue('currentMonth.value', mon);     
			}); $j("#formDate").change();

            // currentMonth uneditable
			$j("#currentMonth").change(function() {
				var formDate = getValue('formDate.value');
				var valueDate = document.getElementById('date-value').innerText;
                var months = diffMonth(valueDate,formDate);
                var mon = parseInt(months);
                setValue('currentMonth.value', mon);     
			}); 

            // monitoring field uneditable
			$j("#glucose_Monitoring").change(function() {
			    setBloodSugarResult();     
			});
            
            // set Blood Sugar Resuly according to selected test id
            $j("#test-list").change(function() {
                setBloodSugarResult();                                          
            }); $j("#test-list").change();
            
            // sugar result field uneditable
            $j("#sugar_result").change(function() {
               setBloodSugarResult();                                        
            });
            
            // sugar test type uneditable
            $j("#sugar_test_type").change(function() {
                setBloodSugarResult();                                       
            });
            
            $j("#visit_number").change(function(){
				
   			 var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(508)) #if($id.encounter.encounterType.id == 41) $id.valueText  #end  #end"/>";
   		     if(value.length == 0)
   		        setValue('visit_number.value', 1);
             else{
                 value = value.replace(/(^\s+|\s+$)/g,'');       
                 var result = value.replace(/\s+/g, ';');         
                 var resultArray = result.split(";");  
                 var visitNumber = resultArray.length + 1;
                 setValue('visit_number.value', visitNumber);
             } 
   		         
   	    }); $j("#visit_number").change();
            
        });
     }
   
     function setBloodSugarResult(){

        var e = document.getElementById("test-list");
        var value = e.options[e.selectedIndex].value;
        var resultArray = value.split(";");
        setValue("sugar_result.value", resultArray[0]);  // set blood sugar test result corresponding to test id
        var number = parseInt(resultArray[0]);
        if(resultArray[1] == 136){   // test type == FBS
           setValue("sugar_test_type.value",517);
          if(number &lt;= 115){   // autopopulate glucose monitoring
             setValue('glucose_Monitoring.value',377); }
          else  {
             setValue('glucose_Monitoring.value',378); }
        }
        else{  // test type == RBS
           setValue("sugar_test_type.value",516);
           if(number &lt;= 160){  // autopopulate glucose monitoring
              setValue('glucose_Monitoring.value',377);
           } 
           else {  
              setValue('glucose_Monitoring.value',378);
            }
        }     

      }
        
     function diffMonth(initialDate,formDate) {
		           
         var a = new Date(initialDate);
         var b = new Date(formDate);

          // Months between years.
        var months = (b.getFullYear() - a.getFullYear()) * 12;

          // Months between... months.
         months += b.getMonth() - a.getMonth();
                   
         return months;
	}
         
     <!-- Error Checking before Form Submit -->
     beforeSubmit.push(function() {
		// Validate barcode
		var valid = true;
		var error = '';
	
        var treatmentInitiated = "<lookup expression="fn.latestObs(388).valueCoded.name" />";
         if(treatmentInitiated == "No"){
                valid = false;
                error = "Diabetes treatment NOT initiated for the patient.\n";
          }
         else  if(treatmentInitiated == "Yes"){
                
          }
         else {
              valid = false;
              error = "Diabetes First Encounter form is not submitted for the patient. Please submit the form to continue.\n";
         }

         var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(508)) #if($id.encounter.encounterType.id == 41) value $id.encounter.encounterDatetime  #end  #end"/>";
         value = value.replace(/ 00:00:00.0/g,'');
         value = value.replace(/value /g,'');
         value = value.replace(/(^\s+|\s+$)/g,'');        // replace all white spaces with single space
         var result = value.replace(/\s+/g, ';');           // replace single space with ;
         var resultArray = result.split(";");                // Split Data from ;
  	  
          var formDate = getValue('formDate.value');
          
          for(var j = resultArray.length-1; 0 &lt;= j; j--){
                  if(resultArray[j] == formDate){
                      valid = false;
                       error = "Duplicate Encounter Date.\n";
                  }
           }
         
         var value = getValue("visit_number.value");
         if(value == ''){
             valid=false;
             error=error+"Visit Number can't be empty.";
         }
         
         if (!valid) {
			alert (error);
		 }
         return valid;
    });
</script>
</htmlform>