<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Drug Dispersal (v1.0)</h2>

	<section headerLabel="2. Encounter Details">
		<table class="baseline-aligned">
				<tr>
					<td>Form Date:</td>
					<td><encounterDate default="today"  id="formDate"/></td>
				</tr>
				<tr>
					<td>Location:</td>
					<td><encounterLocation default="1"/></td>
				</tr>
				<tr>
					<td>Provider (Auto):</td>
					<td><encounterProvider default="currentUser"/></td>
				</tr>
		</table>
	</section>

  Date of Treatment Initiation (Diabetes):
                           <b>   
                                     <lookup complexExpression="#if ($fn.latestObs(388)) $fn.latestObs(388).getEncounter().getEncounterDatetime() #else #end"/> <span id="test-type-span"></span>
                          </b>
	<section headerLabel="2. Drug Delivery">
		<table class="baseline-aligned">
		<div>
			<p>
				Location of Delivery<br/>
				<obs conceptId="322" id="drug_location" answerConceptIds="502,503,504,505,321" defaultValue="321"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('393').description"/><br/>
				<obs conceptId="393" id="drugs_collector" defaultValue="392"/>
			</p>
			<div id="other_collector_div">
				<p>
					<lookup expression="fn.getConcept('394').description"/><br/>
					<obs conceptId="394" id="other_drugs_collector" />
				</p>
			</div>
			<p>
				<lookup expression="fn.getConcept('395').description"/><br/>
				<obs conceptId="395" id="drug_days" />
			</p>
			<p>
				<lookup expression="fn.getConcept('396').description"/><br/>
				<obs conceptId="396" id="missed_medication" defaultValue="2"/>
			</p>
			<div id="missed_medication_div">
				<p>
					<lookup expression="fn.getConcept('397').description"/><br/>
					<obs conceptId="397" id="missed_medication_days" />
				</p>
			</div>
			<p>
				<lookup expression="fn.getConcept('398').description"/><br/>
				<obs conceptId="398" id="next_date" allowFutureDates="true" />
			</p>
		</div>
		</table>
	</section>

	<submit/>
	<script type="text/javascript">
		if(jQuery) {
		$j(document).ready(function() {


                     var lastFood = "<lookup complexExpression="#foreach($id in $fn.allObs(135)) $id.valueCoded #end"/>";
                       if(lastFood == 136){
                          document.getElementById("test-type-span").innerHTML="FBS";
                       }
                       else{
                          document.getElementById("test-type-span").innerHTML="RBS";
                       }

			// If Other collected is selected, enable Other div
			$j("#drugs_collector").change(function() {
                                    
				var otherCollectorDiv = $j("#other_collector_div");
				var drugsCollectorValue = getValue('drugs_collector.value');
				if (drugsCollectorValue == 470) {
					otherCollectorDiv.show();
				}
				else {
					otherCollectorDiv.hide();
				}
			});
			$j("#drugs_collector").change();
			// Disable Haemoptysis if cough is not Yes
			$j("#missed_medication").change(function() {
				var missedMedicationDiv = $j("#missed_medication_div");
				var missedMedicationValue = getValue('missed_medication.value');
				if (missedMedicationValue == 1) {
					missedMedicationDiv.show();
				}
				else {
					missedMedicationDiv.hide();
				}
			});
			$j("#missed_medication").change();


                      $j("#drug_days").change(function() {
				setNextDate();
			});$j("#drug_days").change();

                      $j("#formDate").change(function() {
				setNextDate();
			});

		});
}

      function setNextDate(){
         
                 var formDate = getValue('formDate.value');  
                 var day = getValue('drug_days.value');
                 if(!(formDate == '' ||  day == '')) 
                     {
                           var date = new Date(formDate);
                           var newdate = new Date(date);
                           
                            var number = parseInt(day);

                           newdate.setDate(newdate.getDate() + number);

                            var dd = newdate.getDate();
                            var mm = newdate.getMonth() + 1;
                            var y = newdate.getFullYear();

                            var someFormattedDate = y + '-' + mm + '-' + dd;
                   
                            setValue("next_date.value",someFormattedDate );

                     }
        

      }
            
	</script>
</htmlform>