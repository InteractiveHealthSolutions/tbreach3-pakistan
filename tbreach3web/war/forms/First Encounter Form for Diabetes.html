<htmlform>
	<br/>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>
	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>First Encounter Form for Diabetes (v1.0)</h2>
	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Form Date:</td>
				<td>
					<encounterDate default="today"/>
				</td>
			</tr>
			<tr>
				<td>Location:</td>
				<td>
					<encounterLocation default="1"/>
				</td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td>
					<encounterProvider default="currentUser" type="autocomplete"/>
				</td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Patient Information">
		<div>
			<p>
				Address: <lookup expression="patient.personAddress.address1" />, <lookup expression="patient.personAddress.cityVillage" />, <lookup expression="patient.personAddress.country" />
			</p>
			<p>
				Primary Mobile Number: <lookup expression="personAttributes.get('Primary Mobile')"/>
                Secondary Mobile Number: <lookup expression="personAttributes.get('Secondary Mobile')"/>
			</p>
		</div>
	</section>

	<section headerLabel="3. Test Information">
		<div>
			<p>
                Blood Sugar Test Id:
                <select id="test-list" name="test-list"> 
                </select>
            </p>

            <p>  
				<lookup expression="fn.getConcept('139').description"/>: <obs conceptId="139" id="sugar_result"/> <obs conceptId="518" id="sugar_test_type"/>
			</p>
				<lookup expression="fn.getConcept('114').description"/>: <lookup expression="fn.latestObs(114).valueCoded.name"/>
		</div>
	</section>

    <section headerLabel="4. Enrollment into SZ Diabetes Program">
		<div>
			<p>
				Currently on Diabetic Medication
				<obs conceptId="387" id="diabetes_medicine" answerConceptIds="1,2,3,4," defaultValue="2"/>
			</p>
			<p>
				Does the patient wish to be enrolled within the diabetes treatment program?<br/>
				<obs conceptId="285" id="pt_enrolled" answerConceptIds="1,2,4," defaultValue="1"/>
			</p>
		</div>
	</section>

    <section headerLabel="5. Contraindications">
		<div>
			<div id="female_div">
				<p>
					Currently pregnant?<br/>
					<obs conceptId="286" id="pregnant" defaultValue="2"/>
				</p>
				<p>
					Currently breastfeeding? <br/>
					<obs conceptId="287" id="breastfeeding" defaultValue="2"/>
				</p>
			</div>
            <p>
				 Currently suffering from any renal disease?<br/>
				<obs conceptId="288" id="renal_disease" defaultValue="2"/>
			</p>
			<p>
				 Currently suffering from any liver disease?<br/>
				<obs conceptId="289" id="liver_disease" defaultValue="2"/>
			</p>
            <p>
				<lookup expression="fn.getConcept('506').description"/><br/>
				<obs conceptId="506" id="age" defaultValue="2"/>
			</p>
            <p>
				<lookup expression="fn.getConcept('328').description"/><br/>
				<obs conceptId="328" id="contraindication"  answerConceptIds="1,2,3,4" defaultValue="2"/>
			</p>
        </div>
	</section>
	
	<section headerLabel="6. Treatment Initiation (Diabetes)">
		<div>
			<p>
				Has treatment for diabetes been initiated? <br/>
				<obs conceptId="388" id="treatment_enrollment" answerConceptIds="1,2" defaultValue="1" style="radio"/>				
			</p>
            <div id="no_treatment_div">
                <p>
					<lookup expression="fn.getConcept('278').description"/><br/>
					<obs conceptId="278" id="no_treatment_reason" answerConceptIds="274,4,277,275"/>				
				</p>
                <div id="other_div">
					<p>
						<lookup expression="fn.getConcept('277').description"/><br/>
						<obs conceptId="277" id="other_reason"/>				
					</p>
                </div>
            </div>
            <div id="treatment_div">
				<p>
					<lookup expression="fn.getConcept('320').description"/><br/>
					<obs conceptId="320"  id="treatment_centre" answerConceptIds="502,503,504,505,321"/>
				</p>
				<p>
					<lookup expression="fn.getConcept('322').description"/><br/>
					<obs conceptId="322" id="drug_site" answerConceptIds="502,503,504,505,321"/>
				</p>
            </div>
		</div>
	</section>

    <section headerLabel="7. Treatment Initiation (TB)">
		<div>
			<p>
				Has treatment for TB been initiated?<br/>
				<obs conceptId="271" id="tb_treatment_initiated" answerConceptIds="1,2,3,4" defaultValue="2"/>
			</p>
		</div>
	</section>
	<submit/>
	
	<script type="text/javascript">
	
		if(jQuery){

		    // Form shouldn't only be submit once per patient if treatment initiated is Yes
            var treatmentInitiated = "<lookup expression="fn.latestObs(388).valueCoded.name" />";
            if(treatmentInitiated == "No"){
                alert("First Encounter for Diabetes Form already filled with Treatment NOT initiated.");
            }
            else  if(treatmentInitiated == "Yes"){
                alert("First Encounter for Diabetes Form already filled with Treatment initiated.");
            }

            $j(document).ready(function() {                               
 
                // Retrieving all Blood Sugar Test IDs + Encounter Date from encounter type = Blood Sugar Test Result  
                var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(138)) #if($id.encounter.encounterType.id == 19) $id.valueText+$id.encounter.encounterDatetime  #end  #end"/>";
                value = value.replace(/[+]/g,'(');               // replace + with (
                value = value.replace(/ 00:00:00.0/g,')');       // replace 00:00:00.0 with )
                value = value.replace(/(^\s+|\s+$)/g,'');        // replace all white spaces with single space
                var result = value.replace(/\s+/g, ';');         // replace single space with ;
                var resultArray = result.split(";");             // Split Data from ; 

				// Retrieving all Blood Sugar Result Value from encounter type = Blood Sugar Test Result
                var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(139)) #if($id.encounter.encounterType.id == 19) $id.valueText  #end  #end"/>";
                value = value.replace(/(^\s+|\s+$)/g,'');        // replace all white spaces with single space
                var result = value.replace(/\s+/g, ';');         // replace single space with ;
                var resultValueArray = result.split(";");        // Split Data from ;
				
				// Retrieving all Blood Sugar Test IDs from encounter type = Blood Sugar Test Order
				var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(138)) #if($id.encounter.encounterType.id == 18) $id.valueText  #end  #end"/>";
                value = value.replace(/(^\s+|\s+$)/g,'');        // replace all white spaces with single space
                var result = value.replace(/\s+/g, ';');         // replace single space with ;
                var resultIdArray = result.split(";");           // Split Data from ;
                                    
                // Retrieving last food intake values from encounter type = Blood Sugar Test Order                  
				var value = "<lookup  complexExpression="#foreach($id in $fn.allObs(135)) #if($id.encounter.encounterType.id == 18) $id.valueCoded  #end  #end"/>";
                value = value.replace(/(^\s+|\s+$)/g,'');        // replace all white spaces with single space
                var result = value.replace(/\s+/g, ';');         // replace single space with ;
                var resultTestTypeArray = result.split(";");     // Split Data from ;

                // Concat blood sugar result value with respective last food intake value
                for(var j = resultIdArray.length-1; 0 &lt;= j; j--){     // Blood Sugar Order list of Ids
                    for(var i = resultArray.length-1; 0 &lt;= i; i--){   // Blood Sugar Result list of Ids
                        var array = resultArray[i].split("(");
                        if(resultIdArray[j] == array[0]){                //if both ids match use 'j' index to retrieve last food intake value
                            resultValueArray[i] = resultValueArray[i]+";"+resultTestTypeArray[j]; 
                        }                                      
                    }
                }
                 
                var select = document.getElementById("test-list");        // test ids drop down element
				
                for(var i = resultArray.length-1; 0 &lt;= i; i--){
					var optn = document.createElement("OPTION");
                    var array = resultArray[i].split("(");
					optn.text = array[0].concat(' (').concat(array[1]);   // add test ids with encounter dates as text
                    optn.value = resultValueArray[i];                     // add corresponding blood test result as values
                    select.add(optn, 0);   
                }
                 
                // If gender is male, then hide Pregnancy and Breastfeeding questions
			    var gender = "<lookup expression="patient.gender"/>";
			    var femaleDiv = $j("#female_div");
			    if (gender == "M") {
				    femaleDiv.hide();
			    }

				//Uneditable noTreatmentReason if reason is contraindication and hide and show other_div
                $j("#no_treatment_reason").change(function() {
				    var otherDiv = $j("#other_div");
				    var noTreatmentReasonValue = getValue('no_treatment_reason.value');
                    var pregnant = getValue('pregnant.value');
                    var breastfeeding = getValue('breastfeeding.value');
                    var renal_disease = getValue('renal_disease.value');
                    var liver_disease= getValue('liver_disease.value');
                    var age = getValue('age.value');
                    var contraindication = getValue('contraindication.value');
                    var treatmentInitiatedRadios = $j("input[name=w28]");
                    if(pregnant != 2 || breastfeeding != 2 || renal_disease != 2 || liver_disease != 2 || age != 2 || contraindication != 2 ){
                        setValue('no_treatment_reason.value', 275);
                    }
				    else if (noTreatmentReasonValue == 277) {
							otherDiv.show();
				        }
				         else {
					        otherDiv.hide();
				        }
			    }); $j("#no_treatment_reason").change();
                                    
                $j("#treatment_enrollment").change(function() {
					var noTreatmentDiv = $j("#no_treatment_div");
                    var treatmentDiv = $j("#treatment_div");
                    var treatmentInitiatedRadios = $j("input[name=w28]");
				    var noTreatmentValue = getValue('treatment_enrollment.value');
				    if (noTreatmentValue == 2) {
                        noTreatmentDiv .show();
                        treatmentDiv.hide();
                    }
				    else {
                        var pregnant = getValue('pregnant.value');
                        var breastfeeding = getValue('breastfeeding.value');
                        var renal_disease = getValue('renal_disease.value');
                        var liver_disease= getValue('liver_disease.value');
                        var age = getValue('age.value');
                        var contraindication = getValue('contraindication.value');
                        var treatmentInitiatedRadios = $j("input[name=w28]");
                        if(pregnant != 2 || breastfeeding != 2 || renal_disease != 2 || liver_disease != 2 || age != 2 || contraindication != 2){
                            treatmentInitiatedRadios [1].checked = true;
                        }
                        else{
							noTreatmentDiv .hide();
                             treatmentDiv.show();
                        }
				    }
			    }); $j("#treatment_enrollment").change();

                $j("#pregnant").change(function() {
                    setDisplay();
                });
				
                $j("#breastfeeding").change(function() {
                    setDisplay();
                });
				
                $j("#renal_disease").change(function() {
                     setDisplay();
                });
				
                $j("#liver_disease").change(function() {
                    setDisplay();
                });
				
                $j("#age").change(function() {
                    setDisplay();                                           
                });
				
				// change in selected test id
                $j("#test-list").change(function() {
                    setBloodSugarResult();    //update result                                      
                }); $j("#test-list").change();
				
				// uneditable sugar test result field
                $j("#sugar_result").change(function() {
                    setBloodSugarResult();                                        
                });
				
				// uneditable sugar test type field
                $j("#sugar_test_type").change(function() {
                    setBloodSugarResult();                                       
                }); 
				
				// Autopopulate contraindication and set other corresponding values
                $j("#contraindication").change(function() {
                    var pregnant = getValue('pregnant.value');
                    var breastfeeding = getValue('breastfeeding.value');
                    var renal_disease = getValue('renal_disease.value');
                    var liver_disease= getValue('liver_disease.value');
                    var age = getValue('age.value');
                    var contraindication = getValue('contraindication.value');
                    var treatmentInitiatedRadios = $j("input[name=w28]");
                    if(pregnant != 2 || breastfeeding != 2 || renal_disease != 2 || liver_disease != 2 || age != 2 ){
                        setValue('contraindication.value',1); 
                    }
                    else{
                        var contraindication = getValue('contraindication.value');
                        var treatmentInitiatedRadios = $j("input[name=w28]");
                        if(contraindication == 1)
                        {
                            treatmentInitiatedRadios [1].checked = true;
                            setValue('no_treatment_reason.value', 275);
                        }
                        else
                        {
                            treatmentInitiatedRadios [0].checked = true;
                            setValue('no_treatment_reason.value', "");
                        }
                        var noTreatmentDiv = $j("#no_treatment_div");
                        var treatmentDiv = $j("#treatment_div");
	                    var noTreatmentValue = getValue('treatment_enrollment.value');
		                if (noTreatmentValue == 2) {
				            noTreatmentDiv .show();
                            treatmentDiv.hide();
		                }
		                else {
			                noTreatmentDiv .hide();
                            treatmentDiv.show();
			            }
                    }        
                }); 
				
            });

		}
        
        // Autopopulate values and hide and show div accordingly 		
        function setDisplay() {
            var pregnant = getValue('pregnant.value');
            var breastfeeding = getValue('breastfeeding.value');
            var renal_disease = getValue('renal_disease.value');
            var liver_disease= getValue('liver_disease.value');
            var age = getValue('age.value');
            var contraindication = getValue('contraindication.value');
            var treatmentInitiatedRadios = $j("input[name=w28]");
            if(pregnant != 2 || breastfeeding != 2 || renal_disease != 2 || liver_disease != 2 || age != 2 ){
                setValue('contraindication.value',1);    
                treatmentInitiatedRadios [1].checked = true;
                setValue('no_treatment_reason.value', 275);
            }
            else{
                setValue('contraindication.value',2); 
                treatmentInitiatedRadios [0].checked = true;
                setValue('no_treatment_reason.value', "");
            }

            var noTreatmentDiv = $j("#no_treatment_div");
            var treatmentDiv = $j("#treatment_div");
	        var noTreatmentValue = getValue('treatment_enrollment.value');
		    if (noTreatmentValue == 2) {
				noTreatmentDiv .show();
                treatmentDiv.hide();
		    }
		     else {
			    noTreatmentDiv .hide();
                treatmentDiv.show();
			}
        }
 
        // Autopopulate Sugar test result according to test id selected
        function setBloodSugarResult(){
            var e = document.getElementById("test-list");
            var value = e.options[e.selectedIndex].value;
            var resultArray = value.split(";");
            setValue("sugar_result.value", resultArray[0]);
            if(resultArray[1] == 136)
                setValue("sugar_test_type.value",517);
            else
                setValue("sugar_test_type.value",516);  
        }

        <!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			// Validate barcode
			var valid = true;
			var error = '';
		    var treatmentInitiated = "<lookup expression="fn.latestObs(388).valueCoded.name" />";
            if(treatmentInitiated == "Yes"){  // Don't allow form submission if treatmentInitiated is Yes
                valid = false;
                error = "First Encounter for Diabetes Form already filled with Treatment initiated.";
            }
                
            if (!valid) {
				alert (error);
			}
	        return valid;
		});
	</script>
</htmlform>